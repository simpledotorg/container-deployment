apiVersion: v1
kind: ConfigMap
metadata:
  name: pgback-script
data:
  backup.sh: |
    #!/bin/sh
    apt update -y -qq && \
    apt install awscli -y -qq && \
    pg_dumpall -h $PGHOST -U $PGUSER | \
    gzip | \
    openssl enc -aes-256-cbc -e -pbkdf2 -k $PGPASSWORD | \
    aws --endpoint-url $S3_ENDPOINT s3 cp - s3://$S3_BUCKET/backup-$(date +%Y-%m-%dT%H:%M:%S).sql.gz.enc --no-verify-ssl
