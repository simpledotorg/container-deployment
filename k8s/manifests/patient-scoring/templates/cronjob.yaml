apiVersion: batch/v1
kind: CronJob
metadata:
  name: patient-scoring-cronjob
  labels:
    app.kubernetes.io/name: patient-scoring
spec:
  schedule: "{{ .Values.schedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: patient-scoring
            app.kubernetes.io/component: cronjob
        spec:
          {{- with .Values.podSecurityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          restartPolicy: OnFailure
          containers:
          - name: patient-scoring
            image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
            imagePullPolicy: {{ .Values.image.pullPolicy }}
            command:
            - /bin/bash
            - -c
            - |
              set -e

              # Function to push metrics to Pushgateway using Python
              push_metrics() {
                local score_name="$1"
                local start_time="$2"
                local end_time="$3"
                local status="$4"
                local duration=$((end_time - start_time))

                echo "Pushing metrics for score: ${score_name}, status: ${status}, duration: ${duration}s"

                python3 -c "
import urllib.request
import urllib.error
import sys

score_name = '${score_name}'
end_time = '${end_time}'
status = '${status}'
duration = '${duration}'
pushgateway_url = '${PUSHGATEWAY_URL}'

lb = '{'
rb = '}'
metrics = '''# HELP simple_scoring_batch_last_run_date Epoch timestamp of the last scoring batch run
# TYPE simple_scoring_batch_last_run_date gauge
simple_scoring_batch_last_run_date%sscore=\"%s\"%s %s
# HELP simple_scoring_batch_last_run_status Status of the last scoring batch run (1=success, 0=failure)
# TYPE simple_scoring_batch_last_run_status gauge
simple_scoring_batch_last_run_status%sscore=\"%s\"%s %s
# HELP simple_scoring_batch_last_run_duration_in_seconds Duration of the last scoring batch run in seconds
# TYPE simple_scoring_batch_last_run_duration_in_seconds gauge
simple_scoring_batch_last_run_duration_in_seconds%sscore=\"%s\"%s %s
''' % (lb, score_name, rb, end_time, lb, score_name, rb, status, lb, score_name, rb, duration)

url = '%s/metrics/job/patient_scoring/score/%s' % (pushgateway_url, score_name)
print('Pushing to: %s' % url)

try:
    req = urllib.request.Request(url, data=metrics.encode('utf-8'), method='POST')
    req.add_header('Content-Type', 'text/plain')
    with urllib.request.urlopen(req) as response:
        print('Metrics pushed successfully: HTTP %s' % response.status)
except urllib.error.URLError as e:
    print('Failed to push metrics: %s' % e, file=sys.stderr)
    sys.exit(1)
"
              }

              # Construct DATABASE_URL from environment variables
              export DATABASE_URL="postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}"

              echo "============================================"
              echo "Patient Scoring CronJob Started"
              echo "============================================"
              echo "Database Host: ${DB_HOST}:${DB_PORT}"
              echo "Database Name: ${DB_NAME}"
              echo "============================================"

              cd /app

              # Run training
              echo "Running train.sh..."
              TRAIN_START=$(date +%s)
              if ./train.sh; then
                TRAIN_STATUS=1
              else
                TRAIN_STATUS=0
              fi
              TRAIN_END=$(date +%s)
              push_metrics "training" "$TRAIN_START" "$TRAIN_END" "$TRAIN_STATUS"

              # Run scoring
              echo "Running scoring.sh..."
              SCORING_START=$(date +%s)
              if ./scoring.sh; then
                SCORING_STATUS=1
              else
                SCORING_STATUS=0
              fi
              SCORING_END=$(date +%s)
              push_metrics "risk_score" "$SCORING_START" "$SCORING_END" "$SCORING_STATUS"

              echo "============================================"
              echo "Patient Scoring CronJob Completed!"
              echo "============================================"

              # Exit with error if any step failed (after metrics are pushed)
              if [ "$TRAIN_STATUS" -eq 0 ] || [ "$SCORING_STATUS" -eq 0 ]; then
                echo "One or more steps failed. Exiting with error."
                exit 1
              fi
            env:
            - name: PUSHGATEWAY_URL
              value: "http://prometheus-pushgateway.{{ .Values.pushgateway.namespace }}.svc.cluster.local:9091"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.database.secretName }}
                  key: user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.database.secretName }}
                  key: password
            - name: DB_HOST
              value: "{{ .Values.database.host }}"
            - name: DB_PORT
              value: "{{ .Values.database.port }}"
            - name: DB_NAME
              value: "{{ .Values.database.name }}"
            resources:
              {{- toYaml .Values.resources | nindent 14 }}
          {{- with .Values.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
