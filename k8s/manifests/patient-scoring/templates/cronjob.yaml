apiVersion: batch/v1
kind: CronJob
metadata:
  name: patient-scoring-cronjob
  labels:
    app.kubernetes.io/name: patient-scoring
spec:
  schedule: "{{ .Values.schedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app.kubernetes.io/name: patient-scoring
            app.kubernetes.io/component: cronjob
        spec:
          {{- with .Values.podSecurityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          restartPolicy: OnFailure
          containers:
          - name: patient-scoring
            image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
            imagePullPolicy: {{ .Values.image.pullPolicy }}
            command:
            - /bin/bash
            - -c
            - |
              set -e

              # Construct DATABASE_URL from environment variables
              export DATABASE_URL="postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}"

              echo "============================================"
              echo "Patient Scoring CronJob Started"
              echo "============================================"
              echo "Database Host: ${DB_HOST}:${DB_PORT}"
              echo "Database Name: ${DB_NAME}"
              echo "============================================"

              cd /app
              echo "Running train.sh..."
              ./train.sh

              echo "Running scoring.sh..."
              ./scoring.sh

              echo "============================================"
              echo "Patient Scoring CronJob Completed!"
              echo "============================================"
            env:
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.database.secretName }}
                  key: user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.database.secretName }}
                  key: password
            - name: DB_HOST
              value: "{{ .Values.database.host }}"
            - name: DB_PORT
              value: "{{ .Values.database.port }}"
            - name: DB_NAME
              value: "{{ .Values.database.name }}"
            resources:
              {{- toYaml .Values.resources | nindent 14 }}
          {{- with .Values.nodeSelector }}
          nodeSelector:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.affinity }}
          affinity:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.tolerations }}
          tolerations:
            {{- toYaml . | nindent 12 }}
          {{- end }}
