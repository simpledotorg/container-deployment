apiVersion: v1
kind: ConfigMap
metadata:
  name: patient-scoring-metrics-script
data:
  push_metrics.py: |
    #!/usr/bin/env python3
    import urllib.request
    import urllib.error
    import sys
    import os

    score = os.environ.get('SCORE_NAME', 'unknown')
    end = os.environ.get('END_TIME', '0')
    stat = os.environ.get('STATUS', '0')
    dur = os.environ.get('DURATION', '0')
    url = os.environ.get('PUSH_URL', '')

    if not url:
        print("PUSH_URL not set, skipping metrics push")
        sys.exit(0)

    metrics = """# HELP simple_scoring_batch_last_run_date Epoch timestamp of the last scoring batch run
    # TYPE simple_scoring_batch_last_run_date gauge
    simple_scoring_batch_last_run_date{score="%s"} %s
    # HELP simple_scoring_batch_last_run_status Status of the last scoring batch run (1=success, 0=failure)
    # TYPE simple_scoring_batch_last_run_status gauge
    simple_scoring_batch_last_run_status{score="%s"} %s
    # HELP simple_scoring_batch_last_run_duration_in_seconds Duration of the last scoring batch run in seconds
    # TYPE simple_scoring_batch_last_run_duration_in_seconds gauge
    simple_scoring_batch_last_run_duration_in_seconds{score="%s"} %s
    """ % (score, end, score, stat, score, dur)

    print("Pushing to: %s" % url)
    try:
        req = urllib.request.Request(url, data=metrics.encode('utf-8'), method='POST')
        req.add_header('Content-Type', 'text/plain')
        resp = urllib.request.urlopen(req)
        print("Metrics pushed successfully: HTTP %s" % resp.status)
    except Exception as e:
        print("Failed to push metrics: %s" % e)
        sys.exit(1)
