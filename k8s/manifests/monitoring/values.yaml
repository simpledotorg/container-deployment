grafana:
  datasources:
   datasources.yaml:
     apiVersion: 1
     datasources:
     - name: Prometheus
       type: prometheus
       url: http://monitoring-prometheus-server
       access: proxy
       isDefault: true
prometheus:
  alertmanager:
    extraSecretMounts:
      - name: secret-files
        mountPath: /etc/secrets
        subPath: ""
        secretName: alertmanager-secrets
        readOnly: true
    config:
      receivers:
        - name: default-receiver
          slack_configs:
            - channel: '#test-01'
              send_resolved: true
              api_url_file: /etc/secrets/slack-api-url
              text: '{{ template "slack-message-description" . }}'
    templates:
      alertmanager.tmpl: |-
        {{ define "slack-message-title" }}
        [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
        {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
          {{" "}}(
          {{- with .CommonLabels.Remove .GroupLabels.Names }}
            {{- range $index, $label := .SortedPairs -}}
              {{ if $index }}, {{ end }}
              {{- $label.Name }}="{{ $label.Value -}}"
            {{- end }}
          {{- end -}}
          )
        {{- end }}
        {{end}}

        {{ define "slack-message-description" }}
        {{ range .Alerts -}}
        *Alert:* {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

        *Description:* {{ .Annotations.description }}

        *Details:*
          {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
          {{ end }}
        {{ end }}
        {{end}}
